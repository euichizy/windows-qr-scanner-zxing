# QR 二维码识别工具 (ZXing版)

一个极简的 Windows 系统托盘二维码识别工具，使用 ZXing-CPP 库提供稳定可靠的二维码识别功能。

## 功能特性

### 核心功能
- **截图识别**: 按快捷键（默认 F9）或双击托盘图标，拖拽选择屏幕区域进行二维码识别
- **二维码生成**: 支持生成二维码图片，可选择不同尺寸和纠错级别
- **自动复制**: 识别成功后自动将内容复制到剪贴板
- **系统托盘**: 最小化到系统托盘，不占用任务栏空间
- **DPI 感知**: 支持高 DPI 显示器，确保截图坐标准确

### 快捷键功能
- **扫码快捷键**: 自定义截图识别快捷键（默认 Ctrl+Alt+Q）
- **生成快捷键**: 可选启用二维码生成快捷键（默认 Ctrl+Q，默认禁用）
- **修饰键支持**: 支持 Ctrl、Alt、Shift、Win 等修饰键组合
- **配置持久化**: 快捷键配置自动保存，重启后保持设置

### 高级设置
- **开机自启**: 支持设置开机自动启动
- **设置菜单**: 二级菜单结构，分类管理各项设置
- **配置管理**: 所有配置自动保存到本地文件

## 使用方法

### 启动程序
```bash
# 直接运行
.\build\Release\QRCodeTool.exe

# 或使用批处理文件
.\run_zxing.bat
```

### 操作说明

#### 1. 截图识别
- 按快捷键（默认 Ctrl+Alt+Q）或双击托盘图标
- 拖拽鼠标选择包含二维码的区域
- 识别成功后内容会自动复制到剪贴板
- 按 ESC 键取消选择

#### 2. 生成二维码
- 右键托盘图标 → "生成二维码"（或使用快捷键 Ctrl+Q，需先启用）
- 在文本框中输入内容（支持多行，按 Enter 换行）
- 内容变化后自动生成预览（延迟 500ms）
- 选择二维码尺寸（小/中/大/超大）
  - **注意**: 尺寸仅影响保存的文件大小
  - 预览始终固定缩放到预览区域（380x380）
- 选择纠错级别（低/中/高/最高）
  - **数据容量上限**（Version 40）:
    - 低 (L): 最大 2953 字节
    - 中 (M): 最大 2331 字节
    - 高 (Q): 最大 1663 字节
    - 最高 (H): 最大 1273 字节
  - 超出限制时会提示并建议降低纠错级别
- 保存为 PNG 或 JPG 格式
- 或直接复制到剪贴板

#### 3. 设置管理
右键托盘图标 → "设置" 子菜单：

**扫码快捷键设置**:
- 勾选修饰键（Ctrl、Alt、Shift、Win）
- 选择主按键（F1-F12、A-Z、0-9 等）
- 点击"应用"保存，"恢复默认"重置为 Ctrl+Alt+Q
- 配置保存到 `config.ini` 文件

**生成快捷键设置**:
- 勾选"启用生成二维码快捷键"
- 设置快捷键组合（默认 Ctrl+Q）
- 点击"应用"保存设置
- 配置保存到 `config.ini` 文件

**开机自启**:
- 点击菜单项切换启用/禁用状态
- 启用时菜单项显示勾选标记
- 通过 Windows 注册表实现
- 配置保存到 `config.ini` 文件

#### 4. 右键菜单结构
```
├─ 截图扫码 (ZXing)
├─ 生成二维码
├─ 设置
│  ├─ 扫码快捷键设置
│  ├─ 生成快捷键设置
│  ├─ ──────────
│  └─ 开机自启 [✓]
├─ ──────────
└─ 退出
```

## 技术特性

- **识别库**: 使用 ZXing-CPP 库，支持多种二维码格式
- **生成库**: 使用 nayuki QR code generator 生成高质量二维码
- **图像处理**: 使用 GDI+ 进行屏幕截图和图像处理
- **多线程**: 识别过程在后台线程执行，不阻塞 UI

## 调试功能

程序包含详细的调试输出，可以使用以下方法查看：

### 方法1: 使用 DebugView
1. 下载 [DebugView](https://docs.microsoft.com/en-us/sysinternals/downloads/debugview)
2. 运行 DebugView，启用 "Capture Win32" 选项
3. 运行 QRCodeTool.exe
4. 在 DebugView 中观察调试输出

### 方法2: Visual Studio 调试
1. 在 Visual Studio 中打开项目
2. 按 F5 调试运行
3. 在"输出"窗口中查看调试信息

### 调试文件
- `debug_capture_zxing.png`: 每次识别时保存的截图文件，用于调试识别问题

## 编译说明

### 依赖库
- ZXing-CPP: 二维码识别库
- nayuki-qr-code-generator: 二维码生成库
- GDI+: Windows 图像处理库

### 编译步骤
```bash
# 安装依赖 (使用 vcpkg)
vcpkg install nu-book-zxing-cpp
vcpkg install unofficial-nayuki-qr-code-generator

# 配置项目
cmake -B build -S . -DCMAKE_TOOLCHAIN_FILE=[vcpkg root]/scripts/buildsystems/vcpkg.cmake

# 编译
cmake --build build --config Release
```



## 配置文件说明

程序会在可执行文件同目录下创建以下配置文件：

- **config.ini**: 统一配置文件（INI 格式）
  ```ini
  [Hotkeys]
  ScanModifiers=6        # 扫码修饰键 (6=Ctrl+Alt)
  ScanKey=81             # 扫码按键 (81='Q')
  GenerateModifiers=2    # 生成修饰键 (2=Ctrl)
  GenerateKey=81         # 生成按键 (81='Q')
  GenerateEnabled=0      # 生成快捷键启用状态 (0=禁用, 1=启用)
  
  [Settings]
  AutoStart=0            # 开机自启 (0=禁用, 1=启用)
  ```
  
- **debug_capture_zxing.png**: 调试用截图文件（每次识别时更新）

### 修饰键值说明
- 1 = Alt
- 2 = Ctrl
- 4 = Shift
- 8 = Win
- 组合值为相加（如 6 = Ctrl+Alt）

## 版本历史

### v4.2 (ZXing版 - 完整设置系统)
- **新增设置二级菜单**: 更清晰的设置分类管理
- **开机自启功能**: 支持设置开机自动启动，菜单显示勾选状态
- **生成快捷键**: 可选启用二维码生成快捷键（默认 Ctrl+Q，默认禁用）
- **快捷键优化**: 
  - 扫码快捷键默认改为 Ctrl+Alt+Q
  - 生成快捷键默认为 Ctrl+Q（需手动启用）
- **二维码生成优化**:
  - 文本输入框支持换行（按 Enter 键）
  - 输入内容变化时自动生成预览（延迟 500ms）
  - 预览固定缩放到 380x380 区域
  - 尺寸选项仅影响保存的文件，不影响预览
  - 切换尺寸时自动更新预览
  - **数据上限检查**: 根据纠错级别提示最大容量（2953/2331/1663/1273 字节）
- **界面布局优化**:
  - 生成窗口从 600x600 扩大到 700x650
  - 预览区域从 300x300 扩大到 400x400
  - 优化控件间距和按钮布局
- **配置管理**: 
  - 统一配置文件 `config.ini`（INI 格式）
  - 所有设置自动保存，重启后保持

### v4.1 (ZXing版 - 快捷键自定义)
- 新增快捷键自定义功能，支持修改截图识别快捷键
- 支持 Ctrl、Alt、Shift、Win 修饰键组合
- 快捷键配置自动保存，重启后保持设置
- 优化设置界面，提供友好的配置体验

### v4.0 (ZXing版)
- 切换到 ZXing-CPP 库，提供更稳定的识别能力
- 优化代码结构，移除不必要的测试代码
- 改进错误处理和调试输出

### v3.0 (quirc版)
- 修复 DPI 缩放问题
- 修复消息循环 BUG
- 添加线程安全处理

## 许可证

本项目使用 MIT 许可证。

## 技术实现细节

### 二维码生成预览机制
- **双位图系统**: 
  - `pGdiplusBitmap`: 按用户选择的尺寸生成，用于保存文件
  - `hPreviewBitmap`: 固定 380x380 尺寸，用于界面预览
- **自动缩放**: 使用 GDI+ 高质量插值将大尺寸二维码缩放到预览区域
- **实时更新**: 输入变化、尺寸切换、纠错级别改变时自动重新生成

### 快捷键管理
- **双快捷键系统**: 
  - `HOTKEY_ID (1)`: 扫码快捷键（始终启用）
  - `HOTKEY_GEN_ID (2)`: 生成快捷键（可选启用）
- **配置格式**: 使用逗号分隔的整数存储修饰键和虚拟键码
- **注册表集成**: 开机自启通过 `HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run` 实现

### 界面优化
- **自动生成**: 使用 500ms 定时器防止频繁生成
- **Unicode 支持**: 全程使用 UTF-16 和 UTF-8 转换，支持中文等多语言
- **DPI 感知**: 确保在高 DPI 显示器上正确显示

## 已完成的改进
- ✅ 优化 GUI 界面布局和用户体验
- ✅ 修复 QR Code 生成界面文本无法换行的问题
- ✅ 实现输入内容变化时自动生成 QR Code
- ✅ 修复切换 QR Code 尺寸时预览界面显示不完整的问题
- ✅ 添加设置二级菜单
- ✅ 实现开机自启功能
- ✅ 添加生成快捷键设置
